parameters:
  - name: publishArtifactName # artifact name for publish task
    type: string

steps:
  - task: UseNode@1
    displayName: "Use Node 22.x"
    inputs:
      version: 22.x

  - pwsh: |
      Write-Host "Installing Yarn"
      npm install --global yarn@1.22.19
      Write-Host "Installing VSCE"
      npm install --global vsce@2.9.2
    displayName: Install toolchain

  - pwsh: |
      yarn --frozen-lockfile
    displayName: Install extension depedencies
    workingDirectory: "$(Build.SourcesDirectory)/sql-database-projects"

  - pwsh: |
      yarn run build --prod
    displayName: Build extension
    workingDirectory: "$(Build.SourcesDirectory)/sql-database-projects"

  - pwsh: |
      yarn lint
    displayName: Lint code
    workingDirectory: "$(Build.SourcesDirectory)/sql-database-projects"
    continueOnError: true

  - pwsh: |
      yarn test
    displayName: Run tests
    workingDirectory: "$(Build.SourcesDirectory)/sql-database-projects"
    continueOnError: true

  - task: PublishTestResults@2
    displayName: Publish test results
    inputs:
      testResultsFormat: "JUnit"
      testResultsFiles: "$(Build.SourcesDirectory)/sql-database-projects/test-reports/test-results-ext.xml"
    condition: succeededOrFailed()
    continueOnError: true

  - task: PublishCodeCoverageResults@2
    displayName: Publish code coverage
    inputs:
      summaryFileLocation: "$(Build.SourcesDirectory)/sql-database-projects/coverage/cobertura-coverage.xml"
    condition: succeededOrFailed()
    continueOnError: true

  - pwsh: |
      yarn package
    displayName: Package extension
    workingDirectory: "$(Build.SourcesDirectory)/sql-database-projects"

  # using CopyFiles to isolate all .vsix packages because PublishPipelineArtifact can't use wildcards
  - task: CopyFiles@2
    displayName: "Copy VSIXs to clean folder"
    inputs:
      SourceFolder: "$(Build.SourcesDirectory)/sql-database-projects"
      Contents: "*.vsix"
      TargetFolder: "$(Build.ArtifactStagingDirectory)/vsix"

